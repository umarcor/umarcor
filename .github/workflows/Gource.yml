# Authors:
#   Unai Martinez-Corral
#
# Copyright 2021-2022 Unai Martinez-Corral <unai.martinezcorral@ehu.eus>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Gource

on:
  push:
    paths:
      - '.github/workflows/Gource.yml'
      - 'gource/**'
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:


  Params:
    runs-on: ubuntu-latest
    outputs:
      cfg: ${{ steps.params.outputs.cfg }}
      jobs: ${{ steps.params.outputs.jobs }}
    steps:

    - name: 'ðŸ§° Checkout'
      uses: actions/checkout@v3

    - name: Convert YAML config to JSON string
      id: params
      run: ./gource/grc/yaml2json.py

    - shell: python
      run: |
        from json import dump as json_dump
        from pathlib import Path
        from subprocess import check_call

        cfg = ${{ steps.params.outputs.cfg }}
        with open('config.json', "w") as fptr:
            json_dump(cfg, fptr)

    - run: |
        sudo apt update -qq
        sudo apt install -y gource
        ./gource/grc/logs.py -c config.json -m gource/.mailmap

    - uses: actions/upload-artifact@v3
      with:
        name: glogs
        path: /tmp/glogs


  GenerateVideo:
    needs:
      - Params
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.Params.outputs.jobs) }}
    name: ${{ matrix.name }} | ${{ matrix.title }}
    steps:

    - name: 'ðŸ§° Checkout'
      uses: actions/checkout@v3

    - uses: actions/download-artifact@v3
      with:
        name: glogs
        path: /tmp/glogs

    - name: Get job from config
      shell: python
      run: |
        from json import dump as json_dump
        job = ${{ needs.Params.outputs.cfg }}['${{ matrix.name }}']
        with open('job.json', "w") as fptr:
            json_dump(job, fptr)

    - run: ./gource/grc/job.py
      id: job

    - uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.job.outputs.name }}
        path: |
          ${{ steps.job.outputs.artifact }}.mp4
          ${{ steps.job.outputs.artifact }}.jpg
        if-no-files-found: error

  Release:
    needs: GenerateVideo
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v3
      with:
        path: artifact
    - run: |
        cd artifact
        tar czvf glogs.tar.gz glogs
        rm -rf glogs
    - uses: pyTooling/Actions/releaser@r0
      with:
        token: ${{ github.token }}
        files: artifact/**/*
        tag: gource-videos
